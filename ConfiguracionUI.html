<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Attach GMAIL v1.0.4 - Configuración</title>
    
    <!-- Estilos CSS para una interfaz minimalista en blanco y negro -->
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        color: #000;
        background-color: #fff;
        line-height: 1.5;
      }
      
      .container {
        max-width: 850px;
        margin: 0 auto;
        background-color: #fff;
        border: 1px solid #000;
        padding: 25px;
      }

      h1, h4 {
        color: #000;
        text-align: center;
      }

      .section {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 0;
      }

      .section-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #000;
      }

      .form-group {
        margin-bottom: 18px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 95%;
        max-width: 450px;
        padding: 10px;
        border: 1px solid #000;
        border-radius: 0;
        font-size: 14px;
        background-color: #fff;
        color: #000;
      }

      input[type="checkbox"], input[type="radio"] {
        margin-right: 8px;
      }

      .help-text {
        font-size: 12px;
        color: #555;
        margin-top: 4px;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        padding-top: 20px;
        gap: 15px;
      }

      button, .btn-primary, .btn-secondary, .btn-danger {
        padding: 10px 20px;
        border: 1px solid #000;
        border-radius: 0;
        font-size: 14px;
        cursor: pointer;
        background-color: #fff;
        color: #000;
        transition: all 0.2s;
        text-align: center;
      }

      button:hover, .btn-primary:hover, .btn-secondary:hover, .btn-danger:hover {
        background-color: #000;
        color: #fff;
      }

      .btn-primary {
        background-color: #000;
        color: #fff;
      }

      .status {
        margin: 15px 0;
        padding: 12px;
        display: none;
        border: 1px solid #000;
      }

      .status.success, .status.error {
        display: block;
        background-color: #fff;
        color: #000;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        padding: 15px;
        font-size: 14px;
        color: #000;
        border-top: 1px solid #ddd;
      }

      a {
        color: #000;
        text-decoration: underline;
      }

      a:hover {
        text-decoration: none;
      }

      /* File Type Selection */
      .file-types-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .file-types-column { flex: 1; }
      .file-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 10px;
      }
      .file-type-item {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px;
        border: 1px solid #000;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        gap: 5px;
      }
      .file-type-item:hover {
        background-color: #f0f0f0;
      }
      .file-type-item.selected {
        background-color: #000;
        color: #fff;
      }
      .file-type-item i {
        font-size: 20px;
      }

      /* Notification Frequency Selection */
      .notification-freq-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .freq-option input[type="radio"] {
        display: none; /* Hide the actual radio button */
      }
      .freq-option label {
        display: block;
        padding: 10px 15px;
        border: 1px solid #000;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }
      .freq-option label:hover {
        background-color: #f0f0f0;
      }
      .freq-option input[type="radio"]:checked + label {
        background-color: #000;
        color: #fff;
      }

      .danger-zone {
        border: 1px solid #000;
        margin-top: 30px;
      }
      .danger-zone .section-title {
        text-align: center;
        background-color: #000;
        color: #fff;
        padding: 10px;
        margin: 0;
      }
      .danger-zone .section-content {
        padding: 15px;
      }
      .danger-action {
        margin-bottom: 15px;
      }
      .danger-button {
        width: auto;
        padding: 10px 20px;
        background-color: #fff;
        color: #000;
        border: 1px solid #000;
      }
      .danger-button:hover {
        background-color: #000;
        color: #fff;
      }

    </style>
    <!-- Material Icons - Google Font Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  
  <body>
    <div class="container">
      <h1>Configuración de Attach GMAIL v1.0.4</h1>
      
      <div class="section">
        <div class="section-title">Configuración de Sincronización</div>
        <div class="form-group">
          <label for="mainFolder">Nombre de Carpeta Principal:</label>
          <input type="text" id="mainFolder" name="mainFolder">
        </div>
        <div class="form-group">
          <label for="labelName">Nombre de Etiqueta para Correos Procesados:</label>
          <input type="text" id="labelName" name="labelName">
        </div>
        <div class="form-group">
          <label for="maxEmails">Máximo de Correos por Ejecución:</label>
          <input type="number" id="maxEmails" name="maxEmails" min="1" max="500">
        </div>
        <div class="form-group">
          <label for="daysBack">Días Hacia Atrás (0 para sin límite):</label>
          <input type="number" id="daysBack" name="daysBack" min="0">
        </div>
      </div>

      <div class="section">
        <div class="section-title">Filtrado por Dominios</div>
        <div class="form-group">
          <label for="dominiosIncluidos">Dominios a Incluir:</label>
          <input type="text" id="dominiosIncluidos" name="dominiosIncluidos">
          <div class="help-text">Separados por comas. Dejar en blanco para incluir todos.</div>
        </div>
        <div class="form-group">
          <label for="dominiosExcluidos">Dominios a Excluir:</label>
          <input type="text" id="dominiosExcluidos" name="dominiosExcluidos">
          <div class="help-text">Separados por comas. Tiene prioridad sobre los incluidos.</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Filtrado por Tipo de Archivo</div>
        <div class="file-types-container">
          <div class="file-types-column">
            <h4>Incluir Tipos de Archivo</h4>
            <div class="file-type-grid">
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="pdf"><i class="material-icons">picture_as_pdf</i><span>PDF</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="doc,docx"><i class="material-icons">description</i><span>Word</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="xls,xlsx"><i class="material-icons">table_chart</i><span>Excel</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="ppt,pptx"><i class="material-icons">slideshow</i><span>PowerPoint</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="txt"><i class="material-icons">text_snippet</i><span>Texto</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, true)" data-ext="zip,rar"><i class="material-icons">folder_zip</i><span>Zip/Rar</span></div>
            </div>
          </div>
          <div class="file-types-column">
            <h4>Excluir Tipos de Archivo</h4>
            <div class="file-type-grid">
              <div class="file-type-item" onclick="toggleFileType(this, false)" data-ext="exe,bat,cmd"><i class="material-icons">dangerous</i><span>Scripts</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, false)" data-ext="jpg,jpeg,png,gif"><i class="material-icons">image</i><span>Imágenes</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, false)" data-ext="mp4,avi,mov"><i class="material-icons">videocam</i><span>Vídeos</span></div>
              <div class="file-type-item" onclick="toggleFileType(this, false)" data-ext="mp3,wav"><i class="material-icons">audio_file</i><span>Audio</span></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="extensionesPermitidas">Extensiones Permitidas:</label>
          <input type="text" id="extensionesPermitidas" name="extensionesPermitidas">
          <div class="help-text">Separadas por comas (ej: pdf, docx). Dejar en blanco para incluir todas.</div>
        </div>
        <div class="form-group">
          <label for="extensionesExcluidas">Extensiones Excluidas:</label>
          <input type="text" id="extensionesExcluidas" name="extensionesExcluidas">
          <div class="help-text">Separadas por comas (ej: exe, png). Prioridad sobre las permitidas.</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Notificaciones</div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="enviarNotificaciones" name="enviarNotificaciones">
            Enviar notificaciones por correo
          </label>
        </div>
        <div class="form-group" id="frecuencia-notificaciones-container">
          <label>Frecuencia de notificaciones:</label>
          <div class="notification-freq-options">
            <div class="freq-option">
              <input type="radio" name="FRECUENCIA_NOTIFICACIONES" id="notif-diaria" value="diaria" checked>
              <label for="notif-diaria">Diaria</label>
            </div>
            <div class="freq-option">
              <input type="radio" name="FRECUENCIA_NOTIFICACIONES" id="notif-semanal" value="semanal">
              <label for="notif-semanal">Semanal</label>
            </div>
            <div class="freq-option">
              <input type="radio" name="FRECUENCIA_NOTIFICACIONES" id="notif-quincenal" value="quincenal">
              <label for="notif-quincenal">Quincenal</label>
            </div>
            <div class="freq-option">
              <input type="radio" name="FRECUENCIA_NOTIFICACIONES" id="notif-mensual" value="mensual">
              <label for="notif-mensual">Mensual</label>
            </div>
            <div class="freq-option">
              <input type="radio" name="FRECUENCIA_NOTIFICACIONES" id="notif-nunca" value="nunca">
              <label for="notif-nunca">Nunca</label>
            </div>
          </div>
        </div>
        <div class="form-group" id="detalleNotificacionesGroup">
          <label>Nivel de detalle:</label>
          <div>
            <label>
              <input type="radio" name="detalleNotificaciones" id="detalleBasico" value="basico" checked>
              Básico
            </label>
          </div>
          <div>
            <label>
              <input type="radio" name="detalleNotificaciones" id="detalleDetallado" value="detallado">
              Detallado
            </label>
          </div>
        </div>
      </div>
      
      <div class="actions">
        <button id="saveBtn" class="btn-primary">Guardar Configuración</button>
        <button id="testBtn" class="btn-secondary">Ejecutar Prueba</button>
      </div>
      
      <div id="status" class="status"></div>

      <div class="section danger-zone">
        <div class="section-title">Zona de Peligro</div>
        <div class="section-content">
          <div class="danger-action">
            <button id="resetBtn" class="danger-button">Restablecer Valores Predeterminados</button>
          </div>
          <div class="danger-action">
            <button id="eliminarCarpetaBtn" class="danger-button">Eliminar Carpeta Principal</button>
          </div>
          <div class="danger-action">
            <button id="resetearEtiquetasBtn" class="danger-button">Restablecer Etiquetas de Correos Procesados</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Ayuda</div>
        <p><strong>Configuración de Sincronización:</strong><br>Aquí puedes definir el comportamiento principal del script. Establece el nombre de la carpeta donde se guardarán los adjuntos, la etiqueta para los correos procesados, el número máximo de correos a procesar por ejecución (para no exceder los límites de Google) y cuántos días hacia atrás debe buscar el script.</p>
        <p><strong>¿Cómo funciona el filtrado por dominio?</strong><br>Puedes incluir o excluir dominios específicos para controlar qué correos se procesan. Ingresa los dominios separados por comas. Por ejemplo, para recibir solo facturas de proveedores específicos, puedes añadir `proveedor1.com, proveedor2.com` a la lista de incluidos. Para ignorar correos de redes sociales, puedes añadir `facebook.com, twitter.com` a la lista de excluidos.</p>
        <p><strong>¿Cómo automatizo la sincronización?</strong><br>Para que el script se ejecute automáticamente, debes configurar un activador (trigger) en Google Apps Script. Sigue estos pasos:<br>1. Abre el editor de scripts.<br>2. En el menú de la izquierda, haz clic en "Activadores" (un icono de reloj).<br>3. Haz clic en "Añadir activador" en la esquina inferior derecha.<br>4. En la ventana que aparece, asegúrate de que la función a ejecutar sea `syncAttachments`.<br>5. Selecciona "Basado en tiempo" como el tipo de activador.<br>6. Elige la frecuencia que prefieras (por ejemplo, "Cada hora" o "Cada día").<br>7. Guarda el activador.</p>
      </div>

      <div class="section">
        <div class="section-title">Aviso Legal</div>
        <p>Este script se proporciona "tal cual", sin garantías de ningún tipo, expresas o implícitas. Al utilizarlo, asumes toda la responsabilidad por cualquier pérdida de datos o problema que pueda surgir. Se recomienda encarecidamente probar el script con una cuenta de prueba antes de usarlo en un entorno de producción.</p>
      </div>

      <footer>
        <p>Desarrollado por <a href="https://github.com/686f6c61" target="_blank">686f6c61</a> © <span id="year"></span></p>
      </footer>
    </div>
    
    <script>
      document.getElementById('year').textContent = new Date().getFullYear();

      function loadCurrentConfig() {
        google.script.run
          .withSuccessHandler(updateFormValues)
          .withFailureHandler(showError)
          .cargarConfiguracion();
      }
      
      function updateFormValues(config) {
        document.getElementById('mainFolder').value = config.MAIN_FOLDER_NAME || '';
        document.getElementById('labelName').value = config.PROCESSED_LABEL_NAME || '';
        document.getElementById('maxEmails').value = config.MAX_EMAILS_TO_PROCESS || 50;
        document.getElementById('daysBack').value = config.DAYS_TO_LOOK_BACK || 0;
        
        if (config.DOMINIOS_INCLUIDOS && Array.isArray(config.DOMINIOS_INCLUIDOS)) {
          document.getElementById('dominiosIncluidos').value = config.DOMINIOS_INCLUIDOS.join(', ');
        }
        
        if (config.DOMINIOS_EXCLUIDOS && Array.isArray(config.DOMINIOS_EXCLUIDOS)) {
          document.getElementById('dominiosExcluidos').value = config.DOMINIOS_EXCLUIDOS.join(', ');
        }

        if (config.EXTENSIONES_PERMITIDAS && Array.isArray(config.EXTENSIONES_PERMITIDAS)) {
          document.getElementById('extensionesPermitidas').value = config.EXTENSIONES_PERMITIDAS.join(', ');
        }
        
        if (config.EXTENSIONES_EXCLUIDAS && Array.isArray(config.EXTENSIONES_EXCLUIDAS)) {
          document.getElementById('extensionesExcluidas').value = config.EXTENSIONES_EXCLUIDAS.join(', ');
        }
        
        document.getElementById('enviarNotificaciones').checked = config.ENVIAR_NOTIFICACIONES !== false;
        
        const freq = config.FRECUENCIA_NOTIFICACIONES || 'diaria';
        document.querySelector('input[name="FRECUENCIA_NOTIFICACIONES"][value="' + freq + '"]').checked = true;

        const detalle = config.DETALLE_NOTIFICACIONES || 'basico';
        document.querySelector('input[name="detalleNotificaciones"][value="' + detalle + '"]').checked = true;

        toggleNotificationOptions();
        updateFileTypeSelection();
      }
      
      function saveConfig() {
        const dominiosIncluidos = document.getElementById('dominiosIncluidos').value.split(',').map(e => e.trim()).filter(e => e);
        const dominiosExcluidos = document.getElementById('dominiosExcluidos').value.split(',').map(e => e.trim()).filter(e => e);
        const extensionesPermitidas = document.getElementById('extensionesPermitidas').value.split(',').map(e => e.trim()).filter(e => e);
        const extensionesExcluidas = document.getElementById('extensionesExcluidas').value.split(',').map(e => e.trim()).filter(e => e);

        const newConfig = {
          MAIN_FOLDER_NAME: document.getElementById('mainFolder').value,
          PROCESSED_LABEL_NAME: document.getElementById('labelName').value,
          MAX_EMAILS_TO_PROCESS: parseInt(document.getElementById('maxEmails').value, 10),
          DAYS_TO_LOOK_BACK: parseInt(document.getElementById('daysBack').value, 10),
          DOMINIOS_INCLUIDOS: dominiosIncluidos,
          DOMINIOS_EXCLUIDOS: dominiosExcluidos,
          EXTENSIONES_PERMITIDAS: extensionesPermitidas,
          EXTENSIONES_EXCLUIDAS: extensionesExcluidas,
          ENVIAR_NOTIFICACIONES: document.getElementById('enviarNotificaciones').checked,
          FRECUENCIA_NOTIFICACIONES: document.querySelector('input[name="FRECUENCIA_NOTIFICACIONES"]:checked').value,
          DETALLE_NOTIFICACIONES: document.querySelector('input[name="detalleNotificaciones"]:checked').value
        };
        
        google.script.run
          .withSuccessHandler(configSaved)
          .withFailureHandler(showError)
          .cambiarConfiguracion(newConfig);
      }
      
      function runTest() {
        showStatus("Ejecutando prueba...", false);
        google.script.run
          .withSuccessHandler(result => {
            let message = "Prueba completada.";
            if (typeof result === 'string') {
              message = result;
            }
            showStatus(message, true);
          })
          .withFailureHandler(showError)
          .testSync();
      }

      function resetConfig() {
        if (confirm("¿Restablecer configuración a valores predeterminados?")) {
          google.script.run
            .withSuccessHandler(config => {
              updateFormValues(config);
              showStatus("Configuración restablecida.", true);
            })
            .withFailureHandler(showError)
            .restablecerConfiguracion();
        }
      }

      function eliminarCarpetaPrincipal() {
        if (confirm("¿Está seguro de que desea eliminar la carpeta principal? Esta acción no se puede deshacer.")) {
          google.script.run
            .withSuccessHandler(() => showStatus("Carpeta principal eliminada.", true))
            .withFailureHandler(showError)
            .eliminarCarpetaPrincipal();
        }
      }

      function resetearEtiquetasProcesados() {
        if (confirm("¿Está seguro de que desea restablecer las etiquetas de los correos procesados?")) {
          google.script.run
            .withSuccessHandler(() => showStatus("Etiquetas restablecidas.", true))
            .withFailureHandler(showError)
            .resetearEtiquetasProcesados();
        }
      }
      
      function configSaved(config) {
        updateFormValues(config);
        showStatus("Configuración guardada.", true);
      }

      function showError(error) {
        const statusElem = document.getElementById('status');
        statusElem.textContent = "Error: " + error.message;
        statusElem.className = "status error";
      }

      function showStatus(message, isSuccess) {
        const statusElem = document.getElementById('status');
        statusElem.textContent = message;
        statusElem.className = isSuccess ? "status success" : "status";
      }

      function toggleNotificationOptions() {
        const enabled = document.getElementById('enviarNotificaciones').checked;
        document.getElementById('frecuencia-notificaciones-container').style.display = enabled ? 'block' : 'none';
        document.getElementById('detalleNotificacionesGroup').style.display = enabled ? 'block' : 'none';
      }

      function toggleFileType(element, isInclude) {
        element.classList.toggle('selected');
        const extensions = element.getAttribute('data-ext').split(',');
        const inputId = isInclude ? 'extensionesPermitidas' : 'extensionesExcluidas';
        const input = document.getElementById(inputId);
        let currentExts = input.value ? input.value.split(',').map(e => e.trim()) : [];
        
        if (element.classList.contains('selected')) {
          currentExts.push(...extensions);
        } else {
          currentExts = currentExts.filter(ext => !extensions.includes(ext));
        }
        
        input.value = [...new Set(currentExts)].filter(e => e).join(', ');
      }

      function updateFileTypeSelection() {
        const permitidas = document.getElementById('extensionesPermitidas').value.split(',').map(e => e.trim());
        const excluidas = document.getElementById('extensionesExcluidas').value.split(',').map(e => e.trim());

        document.querySelectorAll('.file-type-item').forEach(el => {
          const exts = el.getAttribute('data-ext').split(',');
          const isInclude = el.parentElement.previousElementSibling.textContent.includes('Incluir');
          const list = isInclude ? permitidas : excluidas;
          
          if (exts.some(ext => list.includes(ext))) {
            el.classList.add('selected');
          } else {
            el.classList.remove('selected');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', function() {
        loadCurrentConfig();
        document.getElementById('saveBtn').addEventListener('click', saveConfig);
        document.getElementById('testBtn').addEventListener('click', runTest);
        document.getElementById('resetBtn').addEventListener('click', resetConfig);
        document.getElementById('eliminarCarpetaBtn').addEventListener('click', eliminarCarpetaPrincipal);
        document.getElementById('resetearEtiquetasBtn').addEventListener('click', resetearEtiquetasProcesados);
        document.getElementById('enviarNotificaciones').addEventListener('change', toggleNotificationOptions);
      });
    </script>
  </body>
</html>