<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attach GMAIL v1.1.0 - Configuración</title>

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ========================================================================
       VARIABLES Y RESET
       ======================================================================== */

    :root {
      --color-primary: #000000;
      --color-secondary: #333333;
      --color-background: #ffffff;
      --color-surface: #fafafa;
      --color-border: #e0e0e0;
      --color-text-primary: #000000;
      --color-text-secondary: #666666;
      --color-hover: #f5f5f5;
      --color-success: #000000;
      --color-error: #000000;
      --spacing: 8px;
      --border-radius: 4px;
      --shadow-1: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-2: 0 4px 8px rgba(0,0,0,0.15);
      --shadow-3: 0 8px 16px rgba(0,0,0,0.2);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: var(--color-surface);
      color: var(--color-text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ========================================================================
       LAYOUT
       ======================================================================== */

    .app-bar {
      background-color: var(--color-primary);
      color: var(--color-background);
      padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
      box-shadow: var(--shadow-2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-bar h1 {
      font-size: 24px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) * 2);
    }

    .app-bar h1 .material-icons {
      font-size: 28px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: calc(var(--spacing) * 3);
    }

    /* ========================================================================
       CARD COMPONENT
       ======================================================================== */

    .card {
      background-color: var(--color-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-1);
      margin-bottom: calc(var(--spacing) * 3);
      overflow: hidden;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-2);
    }

    .card-header {
      padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) * 2);
    }

    .card-header .material-icons {
      color: var(--color-text-secondary);
    }

    .card-header h2 {
      font-size: 18px;
      font-weight: 500;
      flex: 1;
    }

    .card-content {
      padding: calc(var(--spacing) * 3);
    }

    /* ========================================================================
       FORM COMPONENTS
       ======================================================================== */

    .form-group {
      margin-bottom: calc(var(--spacing) * 3);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: calc(var(--spacing));
      color: var(--color-text-primary);
    }

    .form-help {
      display: block;
      font-size: 12px;
      color: var(--color-text-secondary);
      margin-top: calc(var(--spacing) / 2);
    }

    .form-input {
      width: 100%;
      padding: calc(var(--spacing) * 1.5);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: 14px;
      font-family: inherit;
      transition: var(--transition);
      background-color: var(--color-background);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
    }

    .form-input:hover:not(:focus) {
      border-color: var(--color-secondary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(var(--spacing) * 2);
    }

    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* ========================================================================
       CHECKBOX & RADIO
       ======================================================================== */

    .checkbox-group, .radio-group {
      display: flex;
      flex-direction: column;
      gap: calc(var(--spacing) * 1.5);
    }

    .checkbox-label, .radio-label {
      display: flex;
      align-items: center;
      gap: calc(var(--spacing) * 1.5);
      cursor: pointer;
      padding: calc(var(--spacing) * 1.5);
      border-radius: var(--border-radius);
      transition: var(--transition);
    }

    .checkbox-label:hover, .radio-label:hover {
      background-color: var(--color-hover);
    }

    input[type="checkbox"], input[type="radio"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      border: 2px solid var(--color-border);
    }

    /* ========================================================================
       CHIP SELECTOR (para tipos de archivo y frecuencias)
       ======================================================================== */

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: calc(var(--spacing) * 1.5);
      margin-top: calc(var(--spacing) * 1.5);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: calc(var(--spacing));
      padding: calc(var(--spacing)) calc(var(--spacing) * 2);
      border: 1px solid var(--color-border);
      border-radius: 16px;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
      background-color: var(--color-background);
    }

    .chip:hover {
      background-color: var(--color-hover);
      border-color: var(--color-secondary);
    }

    .chip.selected {
      background-color: var(--color-primary);
      color: var(--color-background);
      border-color: var(--color-primary);
    }

    .chip .material-icons {
      font-size: 18px;
    }

    /* ========================================================================
       BUTTONS
       ======================================================================== */

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: calc(var(--spacing));
      padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 3);
      border: none;
      border-radius: var(--border-radius);
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-1);
    }

    .btn:hover {
      box-shadow: var(--shadow-2);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-1);
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-background);
    }

    .btn-secondary {
      background-color: var(--color-background);
      color: var(--color-primary);
      border: 1px solid var(--color-border);
    }

    .btn-secondary:hover {
      background-color: var(--color-hover);
    }

    .btn-danger {
      background-color: var(--color-background);
      color: var(--color-error);
      border: 1px solid var(--color-border);
    }

    .btn-danger:hover {
      background-color: var(--color-error);
      color: var(--color-background);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-group {
      display: flex;
      gap: calc(var(--spacing) * 2);
      flex-wrap: wrap;
    }

    /* ========================================================================
       STATUS / ALERT
       ======================================================================== */

    .alert {
      padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
      border-radius: var(--border-radius);
      margin-bottom: calc(var(--spacing) * 3);
      display: none;
      align-items: start;
      gap: calc(var(--spacing) * 2);
      animation: slideIn 0.3s ease-out;
    }

    .alert.show {
      display: flex;
    }

    .alert-success {
      background-color: var(--color-primary);
      color: var(--color-background);
      border-left: 4px solid var(--color-background);
    }

    .alert-error {
      background-color: #f5f5f5;
      color: var(--color-error);
      border-left: 4px solid var(--color-error);
    }

    .alert .material-icons {
      font-size: 24px;
    }

    .alert-content {
      flex: 1;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========================================================================
       DANGER ZONE
       ======================================================================== */

    .danger-zone {
      border: 2px solid var(--color-error);
      border-radius: var(--border-radius);
      margin-top: calc(var(--spacing) * 4);
    }

    .danger-zone .card-header {
      background-color: var(--color-error);
      color: var(--color-background);
      border-bottom: none;
    }

    .danger-action {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: calc(var(--spacing) * 2);
      border-bottom: 1px solid var(--color-border);
    }

    .danger-action:last-child {
      border-bottom: none;
    }

    .danger-action-info h3 {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: calc(var(--spacing) / 2);
    }

    .danger-action-info p {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    /* ========================================================================
       FOOTER
       ======================================================================== */

    .footer {
      text-align: center;
      padding: calc(var(--spacing) * 4) calc(var(--spacing) * 2);
      color: var(--color-text-secondary);
      font-size: 14px;
      border-top: 1px solid var(--color-border);
      margin-top: calc(var(--spacing) * 4);
    }

    .footer a {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* ========================================================================
       LOADING SPINNER
       ======================================================================== */

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========================================================================
       UTILITIES
       ======================================================================== */

    .hidden {
      display: none !important;
    }

    .text-muted {
      color: var(--color-text-secondary);
    }

    .divider {
      height: 1px;
      background-color: var(--color-border);
      margin: calc(var(--spacing) * 3) 0;
    }
  </style>
</head>

<body>
  <!-- App Bar -->
  <div class="app-bar">
    <h1>
      <span class="material-icons">attachment</span>
      Attach GMAIL v1.1.0
    </h1>
  </div>

  <!-- Main Container -->
  <div class="container">

    <!-- Status Alert -->
    <div id="statusAlert" class="alert">
      <span class="material-icons" id="statusIcon"></span>
      <div class="alert-content" id="statusMessage"></div>
    </div>

    <!-- Configuración de Sincronización -->
    <div class="card">
      <div class="card-header">
        <span class="material-icons">settings</span>
        <h2>CONFIGURACIÓN DE SINCRONIZACIÓN</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label class="form-label" for="mainFolder">Nombre de Carpeta Principal</label>
          <input type="text" id="mainFolder" class="form-input" placeholder="Adjuntos Mail">
          <span class="form-help">Carpeta raíz en Google Drive donde se guardarán los adjuntos</span>
        </div>

        <div class="form-group">
          <label class="form-label" for="labelName">Etiqueta de Correos Procesados</label>
          <input type="text" id="labelName" class="form-input" placeholder="AdjuntosSincronizados">
          <span class="form-help">Etiqueta de Gmail para marcar correos ya procesados</span>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="maxEmails">Correos por Ejecución</label>
            <input type="number" id="maxEmails" class="form-input" min="1" max="500" placeholder="50">
            <span class="form-help">Máximo de correos a procesar en cada ejecución</span>
          </div>

          <div class="form-group">
            <label class="form-label" for="daysBack">Días Hacia Atrás</label>
            <input type="number" id="daysBack" class="form-input" min="0" placeholder="0">
            <span class="form-help">0 = sin límite de tiempo</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtrado por Dominios -->
    <div class="card">
      <div class="card-header">
        <span class="material-icons">filter_list</span>
        <h2>FILTRADO POR DOMINIOS</h2>
      </div>
      <div class="card-content">
        <p style="margin-bottom: 16px; color: var(--color-text-secondary); line-height: 1.5;">
          <strong>¿Qué son los dominios?</strong> El dominio es la parte del correo electrónico después de la @.
          Por ejemplo, en <em>contacto@empresa.com</em>, el dominio es <strong>empresa.com</strong>.
          Usa estos filtros para procesar solo correos de remitentes específicos o bloquear dominios no deseados.
        </p>

        <div class="form-group">
          <label class="form-label" for="dominiosIncluidos">Dominios a Incluir</label>
          <input type="text" id="dominiosIncluidos" class="form-input" placeholder="ejemplo.com, empresa.com, cliente.es">
          <span class="form-help">
            <strong>Ejemplo:</strong> <em>empresa.com, proveedor.es, *.subdominio.com</em><br>
            Separados por comas. Si está vacío, se procesarán todos los dominios excepto los excluidos.
          </span>
        </div>

        <div class="form-group">
          <label class="form-label" for="dominiosExcluidos">Dominios a Excluir</label>
          <input type="text" id="dominiosExcluidos" class="form-input" placeholder="spam.com, publicidad.com, noreply.com">
          <span class="form-help">
            <strong>Ejemplo:</strong> <em>spam.com, publicidad.net, noreply.com</em><br>
            Separados por comas. Los dominios excluidos tienen prioridad sobre los incluidos.
          </span>
        </div>
      </div>
    </div>

    <!-- Filtrado por Tipo de Archivo -->
    <div class="card">
      <div class="card-header">
        <span class="material-icons">insert_drive_file</span>
        <h2>FILTRADO POR TIPO DE ARCHIVO</h2>
      </div>
      <div class="card-content">
        <div class="form-group">
          <label class="form-label">Tipos de Archivo Comunes</label>
          <div class="chip-group">
            <div class="chip" data-ext="pdf">
              <span class="material-icons">picture_as_pdf</span>
              PDF
            </div>
            <div class="chip" data-ext="doc,docx">
              <span class="material-icons">description</span>
              Word
            </div>
            <div class="chip" data-ext="xls,xlsx">
              <span class="material-icons">table_chart</span>
              Excel
            </div>
            <div class="chip" data-ext="ppt,pptx">
              <span class="material-icons">slideshow</span>
              PowerPoint
            </div>
            <div class="chip" data-ext="zip,rar,7z">
              <span class="material-icons">folder_zip</span>
              Comprimidos
            </div>
            <div class="chip" data-ext="jpg,jpeg,png,gif">
              <span class="material-icons">image</span>
              Imágenes
            </div>
            <div class="chip" data-ext="mp4,avi,mov">
              <span class="material-icons">videocam</span>
              Videos
            </div>
            <div class="chip" data-ext="txt,csv">
              <span class="material-icons">text_snippet</span>
              Texto
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="form-group">
          <label class="form-label" for="extensionesPermitidas">Extensiones Permitidas</label>
          <input type="text" id="extensionesPermitidas" class="form-input" placeholder="pdf, docx, xlsx">
          <span class="form-help">Separadas por comas. Dejar en blanco para incluir todas</span>
        </div>

        <div class="form-group">
          <label class="form-label" for="extensionesExcluidas">Extensiones Excluidas</label>
          <input type="text" id="extensionesExcluidas" class="form-input" placeholder="exe, ics">
          <span class="form-help">Separadas por comas. Prioridad sobre las permitidas</span>
        </div>
      </div>
    </div>

    <!-- Notificaciones -->
    <div class="card">
      <div class="card-header">
        <span class="material-icons">notifications</span>
        <h2>NOTIFICACIONES</h2>
      </div>
      <div class="card-content">
        <p style="margin-bottom: 16px; color: var(--color-text-secondary); line-height: 1.5;">
          <strong>¿Qué son las notificaciones?</strong> El sistema puede enviarte un resumen automático por correo electrónico
          con las estadísticas de sincronización: cuántos correos se procesaron, adjuntos guardados, errores, etc.
          Puedes elegir la frecuencia (diaria, semanal, mensual) y el nivel de detalle del resumen.
        </p>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="enviarNotificaciones">
            <span>Enviar notificaciones por correo electrónico</span>
          </label>
        </div>

        <div id="notificationSettings" class="hidden">
          <div class="form-group">
            <label class="form-label" for="emailNotificacion">Correo Electrónico de Destino</label>
            <input type="email" id="emailNotificacion" class="form-input" placeholder="tu-email@gmail.com">
            <span class="form-help">
              <strong>Opcional.</strong> Deja en blanco para usar tu email de Google actual.<br>
              <strong>Caso de uso:</strong> Tienes una cuenta que recibe facturas pero no la monitorizas a diario.
              Configura este email con tu cuenta personal para recibir notificaciones cuando lleguen nuevos PDF u otros archivos,
              manteniéndolos ordenados automáticamente en Drive sin revisar la cuenta secundaria constantemente.
            </span>
          </div>

          <div class="form-group">
            <label class="form-label">Frecuencia de Notificaciones</label>
            <div class="chip-group">
              <div class="chip" data-freq="diaria">Diaria</div>
              <div class="chip" data-freq="semanal">Semanal</div>
              <div class="chip" data-freq="quincenal">Quincenal</div>
              <div class="chip" data-freq="mensual">Mensual</div>
              <div class="chip" data-freq="nunca">Nunca</div>
            </div>
            <span class="form-help" style="display: block; margin-top: 8px;">
              <strong>Ejemplo:</strong> Si eliges <em>Semanal</em>, recibirás un resumen cada 7 días con todas las sincronizaciones.
            </span>
          </div>

          <div class="form-group">
            <label class="form-label">Nivel de Detalle</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="detalle" value="basico" checked>
                <span><strong>Básico</strong> - Solo resumen de correos y adjuntos</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="detalle" value="detallado">
                <span><strong>Detallado</strong> - Incluye estadísticas por dominio y tipo de archivo</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="mensajePersonalizado">Mensaje Personalizado (Opcional)</label>
            <textarea id="mensajePersonalizado" class="form-input" rows="3" placeholder="Escribe un mensaje personalizado que aparecerá al inicio de cada notificación..."></textarea>
            <span class="form-help">
              <strong>Ejemplo:</strong> <em>"Resumen de sincronización del proyecto XYZ"</em> o <em>"Backup automático de facturas"</em>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones Principales -->
    <div class="card">
      <div class="card-content">
        <div class="btn-group">
          <button id="saveBtn" class="btn btn-primary">
            <span class="material-icons">save</span>
            Guardar Configuración
          </button>
          <button id="testBtn" class="btn btn-secondary">
            <span class="material-icons">play_arrow</span>
            Ejecutar Prueba
          </button>
        </div>
      </div>
    </div>

    <!-- Zona de Peligro -->
    <div class="card danger-zone">
      <div class="card-header">
        <span class="material-icons">warning</span>
        <h2>ZONA DE PELIGRO</h2>
      </div>
      <div class="card-content" style="padding: 0;">
        <div class="danger-action">
          <div class="danger-action-info">
            <h3>RESTABLECER CONFIGURACIÓN</h3>
            <p>Restaura todos los valores a sus ajustes predeterminados</p>
          </div>
          <button id="resetBtn" class="btn btn-secondary">
            <span class="material-icons">refresh</span>
            Restablecer
          </button>
        </div>

        <div class="danger-action">
          <div class="danger-action-info">
            <h3>ELIMINAR CARPETA PRINCIPAL</h3>
            <p>Elimina la carpeta de adjuntos (se moverá a la papelera)</p>
          </div>
          <button id="eliminarCarpetaBtn" class="btn btn-danger">
            <span class="material-icons">delete</span>
            Eliminar Carpeta
          </button>
        </div>

        <div class="danger-action">
          <div class="danger-action-info">
            <h3>RESETEAR ETIQUETAS</h3>
            <p>Elimina las etiquetas de procesado para reprocesar correos</p>
          </div>
          <button id="resetearEtiquetasBtn" class="btn btn-danger">
            <span class="material-icons">label_off</span>
            Resetear Etiquetas
          </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>
        Desarrollado por <a href="https://github.com/686f6c61" target="_blank">686f6c61</a>
        •
        <a href="https://github.com/686f6c61/attach-gmail-google-script" target="_blank">Ver en GitHub</a>
        •
        v1.1.0
      </p>
    </div>
  </div>

  <script>
    // =========================================================================
    // ESTADO DE LA APLICACIÓN
    // =========================================================================

    const AppState = {
      config: null,
      loading: false
    };

    // =========================================================================
    // UTILIDADES
    // =========================================================================

    function showStatus(message, isSuccess) {
      const alert = document.getElementById('statusAlert');
      const icon = document.getElementById('statusIcon');
      const messageEl = document.getElementById('statusMessage');

      alert.className = isSuccess ? 'alert alert-success show' : 'alert alert-error show';
      icon.textContent = isSuccess ? 'check_circle' : 'error';
      messageEl.textContent = message;

      // Auto-ocultar después de 5 segundos
      setTimeout(() => {
        alert.classList.remove('show');
      }, 5000);
    }

    function showError(error) {
      showStatus('Error: ' + error.message, false);
    }

    function showTestReport(result) {
      // Construir informe detallado
      let report = '✓ PRUEBA COMPLETADA EXITOSAMENTE\n\n';
      report += '═══════════════════════════════════\n';
      report += 'RESUMEN\n';
      report += '═══════════════════════════════════\n';
      report += `• Correos procesados: ${result.correosProcesados}\n`;
      report += `• Adjuntos guardados: ${result.adjuntosGuardados}\n`;
      report += `• Errores encontrados: ${result.errores}\n`;
      report += `• Tiempo de ejecución: ${result.tiempoTotal}s\n`;
      report += `• Correos pendientes: ${result.correosPendientes}\n`;

      // Dominios procesados
      const dominios = Object.keys(result.dominiosProcesados || {});
      if (dominios.length > 0) {
        report += '\n═══════════════════════════════════\n';
        report += 'DOMINIOS PROCESADOS\n';
        report += '═══════════════════════════════════\n';
        dominios.forEach(dominio => {
          report += `• ${dominio}: ${result.dominiosProcesados[dominio]} correo(s)\n`;
        });
      }

      // Extensiones procesadas
      const extensiones = Object.keys(result.extensionesProcesadas || {});
      if (extensiones.length > 0) {
        report += '\n═══════════════════════════════════\n';
        report += 'TIPOS DE ARCHIVO GUARDADOS\n';
        report += '═══════════════════════════════════\n';
        extensiones.forEach(ext => {
          report += `• .${ext}: ${result.extensionesProcesadas[ext]} archivo(s)\n`;
        });
      }

      report += '\n═══════════════════════════════════\n';
      report += `✓ OK - Sistema funcionando correctamente`;

      // Mostrar el informe en un alert formateado
      alert(report);

      // También mostrar mensaje de éxito en el status
      showStatus('Prueba completada exitosamente. Revise el informe detallado.', true);
    }

    function setLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.dataset.originalHTML = button.innerHTML;
        button.innerHTML = '<span class="spinner"></span> Procesando...';
      } else {
        button.disabled = false;
        button.innerHTML = button.dataset.originalHTML;
      }
    }

    // =========================================================================
    // GESTIÓN DE CONFIGURACIÓN
    // =========================================================================

    function loadCurrentConfig() {
      google.script.run
        .withSuccessHandler(updateFormValues)
        .withFailureHandler(showError)
        .cargarConfiguracion();
    }

    function updateFormValues(config) {
      AppState.config = config;

      // Campos básicos
      document.getElementById('mainFolder').value = config.MAIN_FOLDER_NAME || '';
      document.getElementById('labelName').value = config.PROCESSED_LABEL_NAME || '';
      document.getElementById('maxEmails').value = config.MAX_EMAILS_TO_PROCESS || 50;
      document.getElementById('daysBack').value = config.DAYS_TO_LOOK_BACK || 0;

      // Dominios
      document.getElementById('dominiosIncluidos').value =
        (config.DOMINIOS_INCLUIDOS || []).join(', ');
      document.getElementById('dominiosExcluidos').value =
        (config.DOMINIOS_EXCLUIDOS || []).join(', ');

      // Extensiones
      document.getElementById('extensionesPermitidas').value =
        (config.EXTENSIONES_PERMITIDAS || []).join(', ');
      document.getElementById('extensionesExcluidas').value =
        (config.EXTENSIONES_EXCLUIDAS || []).join(', ');

      // Notificaciones
      document.getElementById('enviarNotificaciones').checked =
        config.ENVIAR_NOTIFICACIONES !== false;

      document.getElementById('emailNotificacion').value =
        config.EMAIL_NOTIFICACION || '';

      document.getElementById('mensajePersonalizado').value =
        config.MENSAJE_PERSONALIZADO || '';

      // Frecuencia de notificaciones (chips)
      const freq = config.FRECUENCIA_NOTIFICACIONES || 'diaria';
      document.querySelectorAll('[data-freq]').forEach(chip => {
        if (chip.dataset.freq === freq) {
          chip.classList.add('selected');
        }
      });

      // Nivel de detalle (radio)
      const detalle = config.DETALLE_NOTIFICACIONES || 'basico';
      document.querySelector(`input[name="detalle"][value="${detalle}"]`).checked = true;

      toggleNotificationSettings();
    }

    function extractConfigFromForm() {
      return {
        MAIN_FOLDER_NAME: document.getElementById('mainFolder').value.trim(),
        PROCESSED_LABEL_NAME: document.getElementById('labelName').value.trim(),
        MAX_EMAILS_TO_PROCESS: parseInt(document.getElementById('maxEmails').value) || 50,
        DAYS_TO_LOOK_BACK: parseInt(document.getElementById('daysBack').value) || 0,
        DOMINIOS_INCLUIDOS: document.getElementById('dominiosIncluidos').value
          .split(',').map(s => s.trim()).filter(s => s),
        DOMINIOS_EXCLUIDOS: document.getElementById('dominiosExcluidos').value
          .split(',').map(s => s.trim()).filter(s => s),
        EXTENSIONES_PERMITIDAS: document.getElementById('extensionesPermitidas').value
          .split(',').map(s => s.trim()).filter(s => s),
        EXTENSIONES_EXCLUIDAS: document.getElementById('extensionesExcluidas').value
          .split(',').map(s => s.trim()).filter(s => s),
        ENVIAR_NOTIFICACIONES: document.getElementById('enviarNotificaciones').checked,
        EMAIL_NOTIFICACION: document.getElementById('emailNotificacion').value.trim(),
        MENSAJE_PERSONALIZADO: document.getElementById('mensajePersonalizado').value.trim(),
        FRECUENCIA_NOTIFICACIONES: document.querySelector('[data-freq].selected')?.dataset.freq || 'diaria',
        DETALLE_NOTIFICACIONES: document.querySelector('input[name="detalle"]:checked')?.value || 'basico'
      };
    }

    // =========================================================================
    // HANDLERS DE EVENTOS
    // =========================================================================

    function handleSaveConfig(e) {
      const button = e.currentTarget;
      setLoading(button, true);

      const newConfig = extractConfigFromForm();

      google.script.run
        .withSuccessHandler(config => {
          setLoading(button, false);
          updateFormValues(config);
          showStatus('Configuración guardada exitosamente', true);
        })
        .withFailureHandler(error => {
          setLoading(button, false);
          showError(error);
        })
        .cambiarConfiguracion(newConfig);
    }

    function handleTestSync(e) {
      const button = e.currentTarget;
      setLoading(button, true);

      google.script.run
        .withSuccessHandler(result => {
          setLoading(button, false);
          showTestReport(result);
        })
        .withFailureHandler(error => {
          setLoading(button, false);
          showError(error);
        })
        .testSync();
    }

    function handleResetConfig() {
      if (!confirm('¿Restablecer toda la configuración a valores predeterminados?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(config => {
          updateFormValues(config);
          showStatus('Configuración restablecida', true);
        })
        .withFailureHandler(showError)
        .restablecerConfiguracion();
    }

    function handleDeleteFolder() {
      if (!confirm('¿Está seguro de eliminar la carpeta principal? Se moverá a la papelera.')) {
        return;
      }

      google.script.run
        .withSuccessHandler(result => {
          showStatus(result.mensaje, result.exito);
        })
        .withFailureHandler(showError)
        .eliminarCarpetaPrincipal();
    }

    function handleResetLabels() {
      if (!confirm('¿Está seguro de resetear las etiquetas de correos procesados?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(result => {
          showStatus(result.mensaje, result.exito);
        })
        .withFailureHandler(showError)
        .resetearEtiquetasProcesados();
    }

    function toggleNotificationSettings() {
      const enabled = document.getElementById('enviarNotificaciones').checked;
      const settings = document.getElementById('notificationSettings');
      settings.classList.toggle('hidden', !enabled);
    }

    // =========================================================================
    // INICIALIZACIÓN
    // =========================================================================

    document.addEventListener('DOMContentLoaded', function() {
      // Cargar configuración inicial
      loadCurrentConfig();

      // Botones principales
      document.getElementById('saveBtn').addEventListener('click', handleSaveConfig);
      document.getElementById('testBtn').addEventListener('click', handleTestSync);

      // Botones de danger zone
      document.getElementById('resetBtn').addEventListener('click', handleResetConfig);
      document.getElementById('eliminarCarpetaBtn').addEventListener('click', handleDeleteFolder);
      document.getElementById('resetearEtiquetasBtn').addEventListener('click', handleResetLabels);

      // Notificaciones toggle
      document.getElementById('enviarNotificaciones')
        .addEventListener('change', toggleNotificationSettings);

      // Chips para tipos de archivo
      document.querySelectorAll('[data-ext]').forEach(chip => {
        chip.addEventListener('click', function() {
          this.classList.toggle('selected');
          updateExtensionsInput();
        });
      });

      // Chips para frecuencia de notificaciones
      document.querySelectorAll('[data-freq]').forEach(chip => {
        chip.addEventListener('click', function() {
          document.querySelectorAll('[data-freq]').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
        });
      });
    });

    function updateExtensionsInput() {
      const selected = Array.from(document.querySelectorAll('[data-ext].selected'))
        .map(chip => chip.dataset.ext)
        .join(',');

      document.getElementById('extensionesPermitidas').value = selected;
    }
  </script>
</body>
</html>
